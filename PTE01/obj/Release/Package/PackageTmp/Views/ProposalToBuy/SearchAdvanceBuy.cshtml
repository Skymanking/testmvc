@model List<Model.View.ProposalToBuyView2>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Theme3.cshtml";

    DateTime homnay = DateTime.Now;
    string ngaythangnam = "ReportMH" + DateTime.Now.ToUniversalTime();
    List<Model.View.Dropdownlist2> listnv = ViewBag.listnv;
}

@section jsFooter
{

    <script src="/Assets/theme3/plugins/timepicker/bootstrap-timepicker.min.js"></script>
    <script>
        $(function () {
            $("#ngay1").datepicker();
            $("#ngay2").datepicker();
            $('input[type="checkbox"].flat-green, input[type="radio"].flat-green').iCheck({
                checkboxClass: 'icheckbox_flat-green',
                radioClass: 'iradio_flat-green'
            })
        })
        
    </script>
}
<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<script>
            $(document).ready(function () {         
                $('#nvmh option[value=@ViewBag.nvmh]').prop('selected', true);
            });

</script>
<link href="~/Assets/js/jquery-ui.css" rel="stylesheet" />
<div class="card card-primary">
    <div class="card-header">
        <h3 class="card-title">Tìm kiếm nâng cao</h3>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="callout callout-info">
                    <label class="control-label" style="color: #FF5722;">Mua Hàng</label><br>
                    <label><input type="radio" class="flat-green" id="damua" name="damua" value="null" checked />Tất cả</label><br>
                    <label><input type="radio" class="flat-green" id="damua" name="damua" value="true" />Đã đặt mua</label><br>
                    <label><input type="radio" class="flat-green" id="damua" name="damua" value="false" />chưa đặt mua</label><br>
                </div>
            </div>
            <div class="col-md-3">
                <div class="callout callout-info">
                    <label class="control-label" style="color: #FF5722;">Nhập Kho</label><br>
                    <label><input type="radio" class="flat-green" id="danhap" name="danhap" value="null" checked />Tất cả</label><br>
                    <label><input type="radio" class="flat-green" id="danhap" name="danhap" value="true" />Đã nhập</label><br>
                    <label><input type="radio" class="flat-green" id="danhap" name="danhap" value="false" />chưa nhập</label><br>
                </div>
            </div>

            <div class="col-md-3">
                <div class="callout callout-info">
                    <label class="control-label" style="color: #FF5722;">Tiến độ</label><br>
                    <select class="form-control" id="tiendo" name="tiendo">
                        <option value="null">Tất cả</option>
                        <option value="-1">đúng hạn</option>
                        <option value="0">chưa đến hạn</option>
                        <option value="1">trễ hạn</option>
                        <option value="7">trễ hạn hơn 7 ngày</option>
                        <option value="14">trễ hạn hơn 14 ngày</option>
                        <option value="21">trễ hạn hơn 21 ngày</option>
                        <option value="30">trễ hạn hơn 30 ngày</option>
                    </select>
                </div>
                <div class="callout callout-info">
                    <label class="control-label" style="color: #FF5722;">NV Mua Hàng</label><br>
                    <select class="form-control" id="nvmh" name="nvmh">
                        <option value="null">Chưa có NV phụ trách</option>
                        @foreach(var item in listnv)
                        {
                            <option value="@item.ID">@item.Name</option>
                        }
                        <option value="all">Tất cả nhân viên</option>
                    </select>
                </div>
            </div>

            <div class="col-md-3">
                <div class="callout callout-info">
                    <label class="control-label" style="color: #FF5722;">Deadline</label>
                    <div class="bootstrap-timepicker">
                        <div class="form-group">
                            <div class="input-group">
                                <label>Từ:</label><input type="text" id="ngay1" name="ngay1" class="time1 form-control" readonly="readonly" value="@if(ViewBag.ngay1 !=null){@ViewBag.ngay1}else{@DateTime.Now.ToShortDateString()}"><br>
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bootstrap-timepicker">
                        <div class="form-group">
                            <div class="input-group">
                                <label>Đến:</label> <input type="text" id="ngay2" name="ngay2" class="time1 form-control" readonly="readonly" value="@if(ViewBag.ngay2 !=null){@ViewBag.ngay2}else{@DateTime.Now.ToShortDateString()}"><br>
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="callout callout-info">
                    <label class="control-label" style="color: #FF5722;">Từ khóa</label><br>
                    <input type="text" class="form-control" id="searchString" name="searchString" placeholder="tên người tạo, phòng ban, tên vật tư...." />

                </div>
            </div>
            <div class="col-md-12 text-center">
                <div class="form-group">
                    <a class="btn btn-primary" id="inbaocao">Tìm kiếm</a>
                </div>
            </div>
        </div>
        <script src="~/Scripts/jquery-1.9.1.min.js"></script>
        <script>
            $(document).ready(function () {
                var damua = $("input[name=damua]:checked").val();
                var danhap = $("input[name=danhap]:checked").val();
                var tiendo = $("#tiendo").val();
                var nvmh = $("#nvmh").val();
                var ngay1 = $('#ngay1').val();
                var ngay2 = $('#ngay2').val();
                var searchString = $('#searchString').val();
                $('#inbaocao').attr("href", '/ProposalToBuy/SearchAdvanceBuy?damua=' + damua + '&nvmh=' + nvmh + '&danhap=' + danhap + '&tiendo=' + tiendo + '&ngay1=' + ngay1 + '&ngay2=' + ngay2 + '&searchString=' + searchString);

                $("#inbaocao").focus(function () {
                    var damua = $("input[name=damua]:checked").val();
                    var danhap = $("input[name=danhap]:checked").val();
                    var nvmh = $("#nvmh").val();
                    var tiendo = $("#tiendo").val();
                    var ngay1 = $('#ngay1').val();
                    var ngay2 = $('#ngay2').val();
                    var searchString = $('#searchString').val();
                    $('#inbaocao').attr("href", '/ProposalToBuy/SearchAdvanceBuy?damua=' + damua + '&nvmh=' + nvmh + '&danhap=' + danhap + '&tiendo=' + tiendo + '&ngay1=' + ngay1 + '&ngay2=' + ngay2 + '&searchString=' + searchString);
                });
               $('#nvmh option[value=@ViewBag.nvmh]').prop('selected', true);
            });

        </script>
    </div>
    <div class="card-footer">

    </div>

</div>


<div class="row">
        <div class="col-md-12">
            <div class="card card-success card-outline">
                <div class="card-header">
                    <h3 class="card-title"> Kết quả</h3>
                    <div class="card-tools">
                        <div class="btn-group" style="height:40px">
                            <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-toggle="dropdown">
                                Tool
                            </button>
                            <div class="dropdown-menu float-right" role="menu">
                                <span class="dropdown-item" onclick="exportTableToExcel('inputdata', '@ngaythangnam')">Export to Excel</span>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="card-body">
                    @if(Model != null)
                    { 
                         <script>
                        function exportTableToExcel(tableID, filename) {
                            var downloadLink;
                            var dataType = 'application/vnd.ms-excel';
                            var tableSelect = document.getElementById(tableID);
                            var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
                            filename = filename ? filename + '.xls' : 'excel_data.xls';
                            downloadLink = document.createElement("a");
                            document.body.appendChild(downloadLink);
                            if (navigator.msSaveOrOpenBlob) {
                                var blob = new Blob(['\ufeff', tableHTML], {
                                    type: dataType
                                });
                                navigator.msSaveOrOpenBlob(blob, filename);
                            } else {
                                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
                                downloadLink.download = filename;
                                downloadLink.click();
                            }
                        }
                    </script>
                 
                      <div class="table-responsive">
                          <table id="inputdata" class="table table-bordered">
                              <thead>
                                  <tr>
                                      <th>Số phiếu</th>
                                      <th>STT</th>
                                      <th>Mã VT</th>
                                      <th>Tên vật tư</th>
                                      <th>Leadtime</th>
                                      <th>MOQ</th>
                                      <th>Số lượng</th>
                                      <th>Người yêu cầu</th>
                                      <th>Bộ Phận</th>
                                      <th>Nhân viên MH</th>
                                      <th width="90px">Ngày tạo</th>
                                      <th width="90px">Deadline Creator</th>
                                      <th width="90px">Deadline Buyer</th>
                                      <th width="90px">Ngày nhập kho</th>
                                      <th>Đã mua</th>
                                      <th>Nhập kho</th>
                                      <th>Nhận vật tư</th>
                                      <th>Tiến độ (Buyer)</th>
                                      <th>Tiến độ (Creator)</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  @foreach (var item in Model)
                                  {

                                      <tr id="row_@item.ID">
                                          <td>@item.ID</td>
                                          <td>@item.No</td>
                                          <td>@item.MaterialID</td>
                                          <td>@item.MaterialName  ( @item.Note )  ĐVT: @item.Unit </td>
                                          <td></td>
                                          <td></td>
                                          <td>@item.Quantity</td>
                                          <td>@item.FullName</td>
                                          <td>@item.Department</td>
                                          <td>@item.NvMH</td>
                                          <td>@item.CreateDate.ToString("dd/MM/yyyy")</td>
                                          <td>@item.LimitedDate2.ToString("dd/MM/yyyy")</td>
                                          <td>@item.LimitedDate.ToString("dd/MM/yyyy")</td>
                                          @if (item.ImportDate == null)
                                          {
                                              <td>chưa nhập</td>
                                          }
                                          else
                                          {
                                              <td>@item.ImportDate.Value.ToString("dd/MM/yyyy")</td>
                                          }
                                       
                                          <td width="70px">@Html.Raw(item.Bought ? "V" : "X")</td>
                                          <td width="70px"> @Html.Raw(item.Imported ? "V" : "X")</td>
                                          <td width="70px">@Html.Raw(item.Recived ? "V" : "X")</td>
                                          @if (item.ImportDate == null)
                                          {
                                              if(item.LimitedDate < DateTime.Now)
                                              {<td>Delayed</td> }
                                              else
                                              { <td>Not due yet</td>}                                              
                                          }
                                          else
                                          {
                                              if (item.LimitedDate < item.ImportDate)
                                              {<td>Delayed</td> }
                                              else
                                              { <td>On time</td>} 
                                          }
                                          @if (item.ImportDate == null)
                                          {
                                              if (item.LimitedDate2 < DateTime.Now)
                                              {
                                              <td>Delayed</td> }
                                              else
                                              {
                                              <td>Not due yet</td>}
                                          }
                                          else
                                          {
                                              if (item.LimitedDate2 < item.ImportDate)
                                              {
                                              <td>Delayed</td> }
                                              else
                                              {
                                              <td>On time</td>}
                                          }
                                      </tr>
                                  }


                              </tbody>
                          </table>
                        
                   
                    </div>
                    }
                    else
                    {
                         <span>chưa có kết quả nào</span>
                    }
                </div>
                <div class="card-footer clearfix">
                   
                </div>
            </div>
        </div>
    </div>






