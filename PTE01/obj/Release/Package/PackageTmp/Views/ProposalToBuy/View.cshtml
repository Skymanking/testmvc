@{
    ViewBag.Title = "View";
    Layout = "~/Views/Shared/_Theme3.cshtml";
    var infoCreateBy = (Model.View.UserView1)ViewBag.ngtao;
    var detail = (Model.View.FullPTB)ViewBag.detail;
    var lenght = detail.detail.Count();
    var quyenxemgia = (bool)ViewBag.quyenxemgia;
    string ngaythangnam = "ReportMH" + DateTime.Now.ToUniversalTime();
}
@section jsFooter
{
    <script src="/Scripts/CancelBuy.js"></script>
}
<div class="card card-primary">

    @if (detail.item.Status == true)
    { <div class="card-header">
        <h3 class="card-title"><i class="fa fa-info-circle" data-toggle="tooltip" title="@detail.item.LimitedHistory . TBP: @detail.item.NameApproval1 . PGD: @detail.item.NameApproval. Mua Hàng: @detail.item.NameApproval2 "></i> Thông Tin Yêu Cầu Mua Vật Tư Đã Được Duyệt - Số Phiếu: <strong>@detail.item.ID</strong></h3>
          <div class="card-tools">
              <div class="btn-group" style="height:40px">
                  <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-toggle="dropdown">
                      Tool
                  </button>
                  <div class="dropdown-menu float-right" role="menu">
                      <span class="dropdown-item" onclick="exportTableToExcel('inputdata', '@ngaythangnam')">Export to Excel</span>
                  </div>
              </div>
          </div>
    </div>
    }
    else
    {<div class="card-header" style="background: #dc3545">
        <h3 class="card-title"><i class="fa fa-info-circle" data-toggle="tooltip" title="@detail.item.LimitedHistory . TBP: @detail.item.NameApproval1 . PGD: @detail.item.NameApproval. Mua Hàng: @detail.item.NameApproval2 "></i> Thông Tin Yêu Cầu Mua Vật Tư Đã Hủy - Số Phiếu: <strong>@detail.item.ID</strong></h3>
         <div class="card-tools">
             <div class="btn-group" style="height:40px">
                 <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-toggle="dropdown">
                     Tool
                 </button>
                 <div class="dropdown-menu float-right" role="menu">
                     <span class="dropdown-item" onclick="exportTableToExcel('inputdata', '@ngaythangnam')">Export to Excel</span>
                 </div>
             </div>
         </div>
    </div>
    }

    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-6 col-xs-6">
                        <p>Người Đề Nghị: <strong>@infoCreateBy.FullName</strong></p>
                    </div>
                    <div class="col-md-6 col-xs-6">
                        <p>Bộ phận: <strong>@infoCreateBy.DepartmentName</strong></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <p>Lý do: @detail.item.Reason</p>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6 col-xs-6'>
                        <p>Ngày yêu cầu: @detail.item.CreateDate.ToString("dd/MM/yyyy")</p>

                    </div>
                    <div class='col-md-6 col-xs-6'>
                        <p>Thời hạn đáp ứng: @detail.item.LimitedDate.ToString("dd/MM/yyyy") </p>
                    </div>
                </div>
                <div class="row" style="padding-top:5px;margin:20px;">
                    <script>
                        function exportTableToExcel(tableID, filename) {
                            var downloadLink;
                            var dataType = 'application/vnd.ms-excel';
                            var tableSelect = document.getElementById(tableID);
                            var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
                            filename = filename ? filename + '.xls' : 'excel_data.xls';
                            downloadLink = document.createElement("a");
                            document.body.appendChild(downloadLink);
                            if (navigator.msSaveOrOpenBlob) {
                                var blob = new Blob(['\ufeff', tableHTML], {
                                    type: dataType
                                });
                                navigator.msSaveOrOpenBlob(blob, filename);
                            } else {
                                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
                                downloadLink.download = filename;
                                downloadLink.click();
                            }
                        }
                    </script>
                    <table class="table table-striped table-bordered table-hover" id="inputdata">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên vật tư</th>
                                <th  style="max-width:400px">Ghi chú</th>
                                <th style="max-width:400px">Ghi chú MH</th>
                                @if (quyenxemgia == true)
                                {
                                    <th>NCC</th>
                                    <th>Đơn giá</th>
                                }

                                <th>ĐVT</th>
                                <th>Số lượng</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < lenght; i++)
                            {
                                <tr id="row">
                                    <td>  @detail.detail[i].No</td>
                                    <td>   @detail.detail[i].MaterialName</td>
                                    <td style="max-width:400px">  @detail.detail[i].Note</td>
                                    <td style="max-width:400px">  @detail.detail[i].NoteMH</td>
                                    @if (quyenxemgia == true)
                                    {
                                        var tenncc = "";
                                        foreach (var item in detail.listvendor)
                                        {
                                            if (item.ID == detail.detail[i].VendorID)
                                            { tenncc = item.Name; }
                                        }
                                        <td>
                                            @tenncc
                                        </td>
                                        <td>
                                            @if (detail.detail[i].Price != null)
                                            {<span>@detail.detail[i].Price.Value.ToString("N0").Replace(',', '.') vnđ</span>}
                                        </td>

                                    }
                                    <td>  @detail.detail[i].Unit</td>
                                    <td>  @detail.detail[i].Quantity</td>
                                </tr>
                            }

                        </tbody>
                    </table>
                    @if (detail.item.Files != null)
                    {
                        <div id="upload" style="margin-top: 10px; border: 1px solid #f2dede; padding: 10px; background: #fcf8e3; " class="col-md-12">
                            @Html.ActionLink("Xem file giải trình, thiết kế ...được đính kèm theo", "DownloadFile", new { fileName = @detail.item.Files })
                        </div>
                    }
                    <script>
                        $(document).ready(function () {
                            $("#files").change(function () {
                                if ($("#files").val().substring(12, 400).length > 2) {
                                    var linktext = "/ProposalToBuy/DownloadFile?fileName=" + $("#files").val().substring(12, 400);
                                    $("#linkfile").attr("href", linktext);
                                    $("#linkfile").show();
                                }
                                else { $("#linkfile").hide(); }
                            });
                        });
                    </script>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <p>Ý kiến của Giám Đốc: @detail.item.Confirm</p>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6 col-xs-6'>
                        <p>Ngày Trưởng Phòng Duyệt: @if (@detail.item.HODDate != null)
                        {@detail.item.HODDate.Value.ToString("dd/MM/yyyy") }</p>

                    </div>
                    <div class='col-md-6 col-xs-6'>
                        <p>Ngày Giám Đốc Duyệt: @if (@detail.item.BOSSDate != null)
                        {@detail.item.BOSSDate.Value.ToString("dd/MM/yyyy") }</p>

                    </div>

                </div>

            </div>



        </div>
    </div>
    <div class="card-footer">
        @if (detail.item.Status == false)
        {
            <button type="button" class="btn btn-danger float-right" data-toggle="modal" data-target="#myModal">Khôi Phục Yêu Cầu </button>
        }
    </div>
</div>

<form id="myForm" method="post">
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">

            Modal content
            <div class="modal-content">
                <div class="modal-header">
                    <span class="float-left"><h4 class="modal-title">Khôi phục yêu cầu đã xóa</h4></span>
                    <span class="float-right"><button type="button" class="close" data-dismiss="modal" style="width:20px">&times;</button></span>
                </div>
                <div class="modal-body">
                    <input class="form-control" data-val="true" id="lydo" name="lydo" placeholder="điền lý do khôi phục " type="text" value="">
                </div>
                <script>
                    $(document).ready(function () {
                        $("#lydo").keypress(function () {
                            var lydos = $('#lydo').val();
                            var abc = $('#huyphieu').attr("data-lydo", lydos);

                        });
                    });
                </script>

                <div class="modal-footer">
                    <a href="#" id="huyphieu" class="btn-cancel" data-id="@detail.item.ID" style="background: red;    padding: 7px;  color: white;">Khôi phục</a>

                </div>
            </div>

        </div>
    </div>
</form>
