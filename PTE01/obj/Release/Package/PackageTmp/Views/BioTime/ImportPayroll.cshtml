@{
    ViewBag.Title = "ImportPayroll";
    Layout = "~/Views/Shared/_Theme3.cshtml";
    System.Data.DataTable daExcel = ViewBag.daTable;
    int dem = 0;
    int year = DateTime.Today.Year;
    int year1 = ViewBag.year;
    int mounth1 = ViewBag.Mounth;
    var countDay = DateTime.DaysInMonth(year1, mounth1);
}
<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<style>
    #table-wrapper {
        position: relative;
    }

    #table-scroll {
        max-height: 75vh;
        overflow: auto;
    }

    #table-wrapper table {
        width: 100%;
    }

        #table-wrapper table * {
            color: black;
        }

        #table-wrapper table thead th .text {
            position: absolute;
            top: -20px;
            z-index: 2;
            height: 20px;
            width: 35%;
            border: 1px solid red;
        }
</style>
<div>
    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title">Import Payroll</h3>
        </div>
        <div class="card-body">

            <div class="row">
                <div class="col-md-2">
                    <label class="control-label">Tháng</label>
                    <select class="form-control" name="mounth" id="mounth">
                        @for (var i = 1; i <= 12; i++)
                        {
                            if (mounth1 == i)
                            {
                                <option selected value="@i">@i</option>
                            }
                            else
                            {
                                <option value="@i">@i</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="control-label">Năm</label>
                    <select class="form-control" name="year" id="year">
                        @for (var i = year - 2; i <= year + 2; i++)
                        {
                            if (year1 == i)
                            {
                                <option selected value="@i">@i</option>
                            }
                            else
                            {
                                <option value="@i">@i</option>
                            }

                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="control-label">File</label><br />
                    <input type='file' id="files" name="file" class="btn btn-info" />
                </div>
                <div class="datcom col-md-3">
                    <label>Upload</label><br />
                    <button type="submit" id="upload" class="btn btn-info">Upload & Show</button>
                </div>
                <div class="datcom col-md-2">
                    <label>Import</label><br />
                    <input type="button" id="import" value="Import" class="btn btn-info" onclick="Check()" />
                </div>
            </div>
        </div>
    </div>
    <script>
        $body = $("body");
        $(document).on({
            ajaxStart: function () { $body.addClass("loading"); },
            ajaxStop: function () { $body.removeClass("loading"); }
        });

        $(document).ready(function () {
            $("#upload").click(function () {
                if ($("#files").val().substring(12, 400) != "") {
                    var linkfile = "/App_Data/uploads/" + $("#files").val().substring(12, 400);
                    var mounth = $("#mounth").val();
                    var year = $("#year").val();
                    $.ajax({
                        url: "/BioTime/CheckImport",
                        data: {
                            mounth: mounth,
                            year: year,
                        },
                        dataType: "json",
                        type: "POST",
                        success: function (response) {
                            var data = new FormData();
                            var files = $("#files").get(0).files;
                            for (i = 0; i < files.length; i++) {
                                data.append("files" + i, files[i]);
                            }
                            if (files.length > 0) {
                                $.ajax({
                                    type: 'POST',
                                    url: "@Url.Action("Upload")",
                                    data: data,
                                    contentType: false,
                                    processData: false,
                                    success: function (data) {
                                        console.log(response);
                                        console.log(data);
                                        if (response == true) {
                                            if (confirm("Dữ liệu tháng năm đã tồn tại. \n Ghi đè?") == true) {
                                                if (files.length > 0) {
                                                    $.ajax({
                                                        url: "/BioTime/UpdateData",
                                                        data: {
                                                            file: linkfile,
                                                            mounth: mounth,
                                                            year: year,
                                                        },
                                                        dataType: "json",
                                                        type: "POST",
                                                        success: function (response) {
                                                        }
                                                    });
                                                }
                                            }
                                        }
                                        else {
                                            if (files.length > 0) {
                                                $.ajax({
                                                    url: "/BioTime/ImportData",
                                                    data: {
                                                        file: linkfile,
                                                        mounth: mounth,
                                                        year: year,
                                                    },
                                                    dataType: "json",
                                                    type: "POST",
                                                    success: function (response) {
                                                    }
                                                });
                                            }
                                        }
                                        var linktext = "/BioTime/ImportPayroll?mounth=" + mounth + "&year=" + year + "&file=" + linkfile;
                                        window.location.href = linktext;
                                    },
                                    error: function () {
                                        var linktext = "/BioTime/ImportPayroll?mounth=" + mounth + "&year=" + year + "&file=" + linkfile;
                                        window.location.href = linktext;
                                    },
                                });
                            }

                        }
                    });
                } else {
                    alert("Chưa chọn file");
                }

            });
        });
    </script>
    <div id="table-wrapper">
        <div id="table-scroll">
            @if (daExcel != null)
            {
                <table class="table table-striped table-bordered table-hover" id="empTable" style="overflow: scroll;">
                    <thead>
                        <tr>
                            <th>Mã NV</th>
                            <th style="min-width: 200px">
                                Tên NV
                            </th>
                            <th style="min-width: 150px">
                                Bộ phận
                            </th>
                            <th>
                                Nhóm
                            </th>
                            <th>NNV</th>
                            <th>
                                Phép ĐT
                            </th>
                            @for (int i = 1; i <= countDay; i++)
                            {
                                <th colspan="2" style="text-align:center">
                                    @i
                                </th>
                            }
                            <th>Ca ngày</th>
                            <th>Ca HC</th>
                            <th>Ca chiều</th>
                            <th>Ca đêm</th>
                            <th>Nghỉ chế độ</th>
                            <th>Nghỉ hưởng 100% lương</th>
                            <th>Nghỉ hưởng 70% lương</th>
                            <th>Nghỉ thứ 7</th>
                            <th>Nghỉ phép có lương</th>
                            <th>Tổng công</th>
                            <th>Thường</th>
                            <th>Chủ nhật</th>
                            <th>Lễ</th>
                            <th>Phụ cấp T7</th>
                            <th>Cơm tăng ca</th>
                            <th>Tiền phụ cấp T7</th>
                            <th>Phép còn lại</th>
                            <th>Tiền cơm CN, Lễ</th>
                            <th>Mức phụ cấp T7</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            @for (int i = 1; i <= countDay; i++)
                            {
                                <th>
                                    NC
                                </th>
                                <th>
                                    TC
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>

                        @foreach (System.Data.DataRow ro in daExcel.Rows)
                        {
                            if (!string.IsNullOrEmpty(ro[0].ToString()) && ro[0].ToString().Substring(0, 1) == "A")
                            {
                                dem = dem + 1;
                                <tr id="Line_@dem">
                                    @for (var col = 0; col <= ro.ItemArray.Length; col++)
                                    {
                                        var id = dem + "_" + col;
                                        <td id="@id">
                                            @try
                                            {@ro[col].ToString()}
                                        catch
                                        {<span></span>}
                                        </td>
                                    }
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>

