@{
    ViewBag.Title = "CheckBOMItem";
    Layout = "~/Views/Shared/_Theme3.cshtml";
    System.Data.DataTable daExcel = ViewBag.daTable;
    int dem = 0;
}
<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<div>
    <div class="row" style="background: #8eeba3;color: #dc3545;">
        <div class="col-12"><center>  <h2>Check BOM Item</h2></center> </div>
    </div>
    <div id="upload" style="margin-top: 10px; border: 1px solid #f2dede; padding: 10px; background: #fcf8e3; " class="row">
        <table class="table">
            <thead>
                <tr>
                    <th>Bước 1</th>
                    <th>Bước 2</th>
                    <th>Bước 3</th>
                    <th>Bước 4</th>
                    <th>Bước 5</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><a class="btn btn-info" href="/ERPCheckBOM/DownloadTemplate">Download Template</a></td>
                    <td><input type='file' id="files" name="item.Files" class="btn btn-info" /> </td>
                    <td><input type="button" id="upload" value="Upload & Show" class="btn btn-info" /></td>
                    <td><input type="button" id="import" value="Check" class="btn btn-info" onclick="Check()" /></td>
                    <td><input type="button" id="import" value="Export to Excel" class="btn btn-info" onclick="ExportToExcel()" /></td>
                </tr>
            </tbody>
        </table>
    </div>


    <script>
        $body = $("body");
        $(document).on({
            ajaxStart: function () { $body.addClass("loading"); },
            ajaxStop: function () { $body.removeClass("loading"); }
        });

        $(document).ready(function () {
            $("#upload").click(function () {
                var data = new FormData();
                var files = $("#files").get(0).files;
                for (i = 0; i < files.length; i++) {
                    data.append("files" + i, files[i]);
                }
                if (files.length > 0) {
                    $.ajax({
                        type: 'POST',
                        url: "@Url.Action("Upload")",
                        data: data,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            var linktext = "/ERPCheckBOM/CheckBOMItem?file=/App_Data/uploads/" + $("#files").val().substring(12, 400);
                            window.location.href = linktext;
                        },
                        error: function () {
                            var linktext = "/ERPCheckBOM/CheckBOMItem?file=/App_Data/uploads/" + $("#files").val().substring(12, 400);
                            window.location.href = linktext;
                        },
                    });
                }
            });
        });
    </script>
    @if (daExcel != null)
    {
        <table class="table table-striped table-bordered table-hover" id="empTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>
                        BOM
                    </th>
                    <th>
                        Count WC
                    </th>
                    <th>
                        Count Matl
                    </th>
                    <th>
                        WC
                    </th>
                    <th>
                        Material
                    </th>
                    <th>
                        Material Name
                    </th>
                </tr>
            </thead>
            <tbody>

                @foreach (System.Data.DataRow ro in daExcel.Rows)
                {
                    if (@ro["Item"] != null && @ro["Item"].ToString().Length > 3 && @ro["Item"].ToString().Length < 17 && @ro["Item"].ToString().Length < 41)
                    {
                        dem = dem + 1;
                        <tr id="Line_@dem">
                            <td id="Item_@dem">
                                @try
                                {@ro["Item"].ToString()}
                            catch
                            {<span></span>}
                            </td>
                            <td id="CBOM_@dem">
                                @try
                                {@ro["Count BOM"].ToString()}
                            catch
                            {<span></span>}
                            </td>
                            <td id="CWC_@dem">
                                @try
                                {@ro["Count WC"].ToString()}
                            catch
                            {<span></span>}
                            </td>
                            <td id="CMalt_@dem">
                                @try
                                {@ro["Count Matl"].ToString()}
                            catch
                            {<span></span>}
                            </td>
                            <td id="WC_@dem">
                                @try
                                {@ro["WC"].ToString()}
                            catch
                            {<span></span>}
                            </td>
                            <td id="Matl_@dem">
                                @try
                                {@ro["Material"].ToString()}
                            catch
                            {<span></span>}
                            </td>
                            <td id="MatlName_@dem">
                                @try
                                {@ro["Material Name"].ToString()}
                            catch
                            {<span></span>}
                            </td>
                        </tr>

                    }
                }
            </tbody>
        </table>
        <script>
            function ExportToExcel() {
                var BOM = "\uFEFF";
                var htmltabel = document.getElementById("empTable");
                var html = htmltabel.outerHTML;
                window.open('data:application/vnd.ms-excel,' + encodeURI(BOM + html));
            }
            function Check() {
                let myTab = document.getElementById('empTable').rows.length;
                for (var i = 1; i < myTab; i++) {
                    let item = document.getElementById("Item_" + i).textContent.replace(/(\r\n|\n|\r| )/gm, "");
                    $.ajax({
                        url: "/ERPCheckBOM/CheckBOMRD",
                        data: { item: item, no: i },
                        dataType: "json",
                        type: "POST",
                        success: function (response) {
                            var item = document.getElementById("Item_" + response.no).textContent;;
                            var rowindex = document.getElementById("Line_" + response.no).rowIndex
                            var table = document.getElementById("empTable");
                            for (let i = 0; i < response.model.length; i++) {
                                if (i == 0) {
                                    if (response.model[i].type == "S") {
                                        document.getElementById("CBOM_" + response.no).innerHTML = "Current";
                                    }
                                    else {
                                        document.getElementById("CBOM_" + response.no).innerHTML = response.model[i].job;
                                    }
                                    document.getElementById("CWC_" + response.no).innerHTML = response.model[i].countWC;
                                    document.getElementById("CMalt_" + response.no).innerHTML = response.model[i].countMatl;
                                    document.getElementById("WC_" + response.no).innerHTML = response.model[i].WC;
                                    document.getElementById("Matl_" + response.no).innerHTML = response.model[i].Malt;
                                    document.getElementById("MatlName_" + response.no).innerHTML = response.model[i].MaltName;
                                }
                                else {
                                    var row = table.insertRow(rowindex + 1);
                                    row.insertCell(0).innerHTML = item;
                                    if (response.model[i].type == "S") {
                                        row.insertCell(1).innerHTML = "Current";
                                    }
                                    else {
                                        row.insertCell(1).innerHTML = response.model[i].job;
                                    }
                                    row.insertCell(2).innerHTML = response.model[i].countWC;
                                    row.insertCell(3).innerHTML = response.model[i].countMatl;
                                    row.insertCell(4).innerHTML = response.model[i].WC;
                                    row.insertCell(5).innerHTML = response.model[i].Malt;
                                    row.insertCell(6).innerHTML = response.model[i].MaltName;
                                }
                            }
                        }
                    });
                }
            }
        </script>
    }
</div>

