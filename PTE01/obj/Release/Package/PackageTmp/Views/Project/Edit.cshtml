@model Model.EF.Task

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Theme3.cshtml";
    long idPro = ViewBag.idPro;
    var detail = (Model.EF.Project)ViewBag.detail;
    var listU = (IEnumerable<Model.View.UserView2>)ViewBag.listUser;
    var listTask = (IEnumerable<Model.View.TaskView4>)ViewBag.listTask;
    var listKey = (IEnumerable<Model.EF.Project>)ViewBag.listKey;
    string nguoitao = ViewBag.nguoitao;
    var nguoinhan = new List<SelectListItem>();
    nguoinhan.Add(new SelectListItem
    {
        Text = "Chọn Người Thực Hiện",
        Value = "none",
        Selected = true
    });
    foreach (var item in listU)
    {
        if (item.FullName == nguoitao)
        {
            nguoinhan.Add(new SelectListItem
            {
                Text = item.FullName,
                Value = item.UserName,
                Selected = true,
            });
        }
        else
        {
            nguoinhan.Add(new SelectListItem
            {
                Text = item.FullName,
                Value = item.UserName,
            });
        }
    }

}

@section jsFooter
{
    <script src="/Assets/theme3/plugins/datepicker/js/bootstrap-datetimepicker.js"></script>
    <script src="/Assets/theme3/plugins/datepicker/js/locales/bootstrap-datetimepicker.fr.js" charset="UTF-8"></script>
    <script>
        $(function () {
            $('.form_datetime').datetimepicker({
                format: 'mm/dd/yyyy hh:ii',
                todayBtn: 1,
                autoclose: 1,
                todayHighlight: 1,
            });
            $('.select2').select2()

        })
    </script>

}
<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<link href="~/Scripts/GranttChart/jsgantt.css" rel="stylesheet" />
<script src="~/Scripts/GranttChart/jsgantt.js"></script>
<div class="card card-primary">
    <div class="card-header">
        <h3 class="card-title">Dự Án @detail.Name</h3>
        <div class="card-tools">
            <div class="btn-group" style="height:40px">
                <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-toggle="dropdown">
                   Filter <i class="fa fa-filter"></i>
                </button>
                <div class="dropdown-menu float-right" role="menu">
                    <a href="/Project/Edit/@detail.ID?searchString=filterC0" style="color:black;" class="dropdown-item"><i class="fa fa-circle fa-2x" style="color: #fdb49d;"></i>Chưa xong + trễ Deadline</a>
                    <a href="/Project/Edit/@detail.ID?searchString=filterC1" style="color:black;" class="dropdown-item"><i class="fa fa-circle fa-2x" style="color: #fbf6cb;"></i>Chưa xong + chưa đến Deadline</a>
                    <a href="/Project/Edit/@detail.ID?searchString=filterC2" style="color:black;" class="dropdown-item"><i class="fa fa-circle fa-2x" style="color: #ceeefd;"></i>Đã xong + trễ Deadline</a>
                    <a href="/Project/Edit/@detail.ID?searchString=filterC3" style="color:black;" class="dropdown-item"><i class="fa fa-circle fa-2x" style="color: #d6f7b1;"></i>Đã xong + đúng Deadline</a>
                    <a href="/Project/Edit/@detail.ID?searchString=filterC-1" style="color:black;" class="dropdown-item"><i class="fa fa-circle fa-2x" style="color: #9E9E9E;"></i>Nhiện vụ bị hủy</a>
                    <a href="/Project/Edit/@detail.ID?searchString=filterC-2" style="color:black;" class="dropdown-item"><i class="fa fa-circle fa-2x" style="color: #795548;"></i>Nhiện vụ bị từ chối</a>
                    <a href="/Project/Edit/@detail.ID?searchString=filterCA" style="color:black;" class="dropdown-item"><i style="width:20px;height:20px;border-radius:50%; background:red;"></i>Tất cả</a>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <span data-toggle="tooltip" id="themnv" data-idnv="" data-idnvb="" title="Thêm nhiệm vụ mới ">Thêm nhiệm vụ mới<i class="fa fa-plus-circle" style="font-size: 20px; color: red" data-toggle="modal" data-target="#toolModal"></i></span>
        <ul class="todo-list">
            @foreach (var item2 in listTask)
            {
                if (item2.IDKey == null)
                {
                    @MyHelper.ViewTask(item2, null)
                }
            }
        </ul>

        @foreach (var item in listKey)
        {
            <div class="card card-info collapsed-card card-outline">
                <div class="card-header" style="background: #eae7e7; color: #009688">
                    <h3 class="card-title"><strong data-toggle="tooltip" title="@item.Description"> @item.Name</strong> (@item.StartDate.ToString("dd/MM/yyyy") - @item.EndDate.ToString("dd/MM/yyyy"))</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-widget="collapse">
                            <i class="fa fa-level-down" style="font-size: 20px;color: #4CAF50;"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <span id="themnvcb_@item.ID" data-idnvb="@item.ID" data-toggle="modal" data-target="#toolModal"><i class="fa fa-plus-circle" style="font-size: 20px; color: red"></i>Thêm nhiệm vụ mới</span>
                    <ul class="todo-list">
                        @foreach (var item2 in listTask)
                        {
                            if (item2.IDKey == item.ID)
                            {
                                @MyHelper.ViewTask(item2, item.ID)
                            }
                        }

                    </ul>
                </div>
            </div>
            <script>
                $(document).ready(function () {
                    $("#themnvcb_@item.ID").click(function () {
                        var abc = $(this).attr("data-idnvb");
                        $('#IDKey').val(abc);
                        $('#IDPar').val('');

                    });
                });
            </script>
        }
    </div>
</div>



<div id="myForm">
    <div class="modal fade" id="toolModal" role="dialog">
        <div class="modal-dialog" style="max-width: 900px;">
            @using (Html.BeginForm("CreateTask", "Project", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" style="width: 50px; font-size: 20px;">&times;</button>
                        <h4 class="modal-title" style="position: absolute;">Tạo nhiệm vụ mới cho Dự Án</h4>
                    </div>
                    <div class="modal-body">
                        <div style="display:none;"><input class="form-control" id="IDPro" name="IDPro" type="text" value="@idPro"></div>
                        <div style="display:none;"><input class="form-control" id="IDKey" name="IDKey" type="text" value=""></div>
                        <div style="display:none;"><input class="form-control" id="IDPar" name="IDPar" type="text" value=""></div>
                        <div class="row">
                            <div class="col-md-12">
                                <label class="control-label col-md-12">Tên Công Việc</label>
                                @Html.TextBoxFor(model => model.Subject, new { @class = "form-control" })
                            </div>
                            <div class="col-md-6">
                                <label class="control-label col-md-12">Owner</label>
                                @Html.DropDownListFor(model => model.Owner, nguoinhan, new { @class = "form-control select2", @style = "width: 100%;" })
                            </div>
                            <div class="col-md-3">
                                <label>Start Date:</label>
                                <div class="input-group date form_datetime" data-link-field="StartDate">
                                    <input class="form-control" type="text" value="" readonly>
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                                    </div>
                                </div>
                                <input type="hidden" id="StartDate" name="StartDate" value="" /><br />
                            </div>
                            <div class="col-md-3">
                                <label>Deadline:</label>
                                <div class="input-group date form_datetime" data-link-field="Deadline">
                                    <input class="form-control" type="text" value="" readonly>
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                                    <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                                    </div>
                                </div>
                                <input type="hidden" id="Deadline" name="Deadline" value="" /><br />
                            </div>

                            <div class="col-md-12">

                                <label class="control-label col-md-12">Diễn giải chi tiết</label>
                                @Html.TextAreaFor(model => model.Description, new { @class = "form-control", @rows = "4" })

                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Lưu thông tin</button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>


<div class="row">
    <div style="position:relative" class="gantt" id="GanttChartDIV"></div>
    <script>

        var g = new JSGantt.GanttChart('g', document.getElementById('GanttChartDIV'), 'day');
        g.setShowRes(1); // Show/Hide Responsible (0/1)
        g.setShowDur(1); // Show/Hide Duration (0/1)
        g.setShowComp(1); // Show/Hide % Complete(0/1)
        g.setCaptionType('Resource');  // Set to Show Caption
        if (g) {
            @foreach(var item in listTask)
            {
                // liet ke cac task không nằm trong phares
                if (item.IDKey == null)
                {@MyHelper.ViewChartTask(item,"")}
            }
            @foreach (var itemkey in listKey)
                {
                        //liet ke cac key miltones
                        <text>
                        g.AddTaskItem(new JSGantt.TaskItem(@itemkey.ID, '@itemkey.Name', '@itemkey.StartDate.ToString("MM/dd/yyyy")', '@itemkey.EndDate.ToString("MM/dd/yyyy")', 'ff0000', 'http://www.yahoo.com', 0, ' ',0,100, 0, 1));                        
                        </text>

                    // liet ke các task trong từng Phare
                    foreach(var item in listTask)
                    {
                        
                         if (item.IDKey == itemkey.ID)
                            {
                                //liet ke các Task không có node cha
                                if(item.IDPar==0 || item.IDPar==null)
                                {
                                    @MyHelper.ViewChartTask(item,"")
                                //liet ke các
                                 foreach(var item2 in listTask)
                                 {
                                     if (item2.IDPar == item.ID)
                                     {
                                         @MyHelper.ViewChartTask(item2, " +")
                                        foreach(var item3 in listTask)
                                         {
                                             if (item3.IDPar == item2.ID)
                                             {
                                                 @MyHelper.ViewChartTask(item3," + +")
                                            }
                                        }
                                    }

                                }
                                }


                            }
                     }
                 }

            g.Draw();
            g.DrawDependencies();


        }
        else {
            alert("not defined");
        }

    </script>
</div>
