@model Model.View.FullBOM

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Theme3.cshtml";
    var i = 0;

    List<Model.EF.WorkCenter> temp1 = ViewBag.WorkCenter;
    List<SelectListItem> listCenter = new List<SelectListItem>();
    listCenter.Add(new SelectListItem
    {
        Text = "chưa chọn",
        Value = "NULL",
        Selected = true
    });
    foreach (var item in temp1)
    {
        listCenter.Add(new SelectListItem
        {
            Text = item.Name,
            Value = item.ID,
        });
    }

    List<Model.EF3.SI_Items> listT = ViewBag.listtemp;
    IEnumerable<Model.View.Dropdownlist2> temp = ViewBag.listProduct;
    List<SelectListItem> listPro = new List<SelectListItem>();
    listPro.Add(new SelectListItem
    {
        Text = "chưa chọn",
        Value = "NULL",
        Selected = true
    });
    foreach (var item in temp)
    {
        listPro.Add(new SelectListItem
        {
            Text = item.Name,
            Value = item.ID,
        });
    }
    List<SelectListItem> listVT = new List<SelectListItem>();

    List<SelectListItem> listBOMType = new List<SelectListItem>();
    listBOMType.Add(new SelectListItem
    {
        Text = "Chuẩn",
        Value = "chuan",
        Selected = true
    });
    listBOMType.Add(new SelectListItem
    {
        Text = "Báo Giá",
        Value = "baogia",
    });
    listBOMType.Add(new SelectListItem
    {
        Text = "Sản Xuất",
        Value = "sanxuat",
    });


}
@section jsFooter
{
    <script src="/Scripts/FindNameVT.js"></script>
    <script>
        $(function () {
            $('.select2').select2()
        })
    </script>

}
<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<div class="row">

    <div class="col-md-12">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">Thông tin BOM</h3>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <div class="row">
                        @using (Html.BeginForm("Create", "BOMItem", FormMethod.Post))
                        {
                            @Html.AntiForgeryToken()
                            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                            <div class="col-12">
                                <div class="row">
                                    <div class='col-md-4'>
                                        <label class="control-label">Mã Sản Phẩm</label>
                                        @Html.DropDownListFor(model => model.item.IDItem, listPro, new { @class = "form-control select2" })
                                    </div>
                                    <div class='col-md-2'>
                                        <label class="control-label">Loại BOM</label>
                                        @Html.DropDownListFor(model => model.item.TypeName, listBOMType, new { @class = "form-control" })
                                    </div>
                                    <div class='col-md-6'>
                                        <label class="control-label">Ghi chú</label>
                                        @Html.TextBoxFor(model => model.item.Note, new { @class = "form-control" })
                                    </div>
                                    <div class='col-md-3'>
                                        <label class="control-label">Chọn Máy Sản Xuất</label>
                                        @Html.DropDownListFor(model => model.item.IDMachine, listCenter, new { @class = "form-control select2" })
                                    </div>
                                    <div class='col-md-3'>
                                        <label class="control-label">Số SP sx trong 1 giờ máy </label>
                                        @Html.TextBoxFor(model => model.item.MachineHour, new { @class = "form-control", @type = "number", @step = "0.000001", @min = "0", @max = "1000000" })
                                    </div>
                                    <div class='col-md-3'>
                                        <label class="control-label">Số SP sx trong 1 giờ công</label>
                                        @Html.TextBoxFor(model => model.item.LabourHour, new { @class = "form-control", @type = "number", @step = "0.000001", @min = "0", @max = "1000000" })
                                    </div>
                                    <div class='col-md-3'>
                                        <label class="control-label">Tỉ lệ đạt %</label>
                                        @Html.TextBoxFor(model => model.item.Yield, new { @class = "form-control", @type = "number", @step = "0.000001", @min = "0", @max = "100" })
                                    </div>                                   
                                    <div class="col-md-6">
                                        <label class="control-label">Tìm tên vật tư</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control tenvt" id="tenvt" placeholder="chỉ hiện 20 kết quả gần giống nhất">
                                            <div class="input-group-append btnFindVT" id="btnFindVT">
                                                <span class="btn btn-default"><i class="fa fa-search"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="control-label">Chọn vật tư muốn đề nghị</label>
                                        <div class='input-group'>
                                            @Html.DropDownList("abc", listVT, new { @class = "form-control" })
                                            <div class="input-group-append" id="btnAddVT">
                                                <span class="btn btn-default"><i class="fa fa-cart-plus"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class=" col-md-12">
                                        <table class="table table-striped table-bordered table-hover" id="gvCustomers">
                                            <thead>
                                                <tr>
                                                    <th style="text-align: center;">Xóa </th>
                                                    <th>Mã VT</th>
                                                    <th>Tên vật tư</th>
                                                    <th>Số lượng</th>
                                                    <th>ĐVT</th>
                                                    <th>Tiêu hao</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <script>
                                        var count = $('#gvCustomers tr').length - 1;
                                        $(document).ready(function () {                                         

                                            function addRowVT() {
                                                if ($("#abc").val() != null) {
                                                    var html =
                                                    '<tr id="dong_' + (count + 1) + '">' +
                                                    '<td width="40px"> <button type="button" data-sodong="' + (count + 1) + '" class="xoadongR"  style="color:red; width:30px;height:30px;border-radius:50%;"><span class="fa fa-trash"></span></button></td>' +
                                                    '<td width="170px"> <input class="form-control" readonly = "true" id="detail_' + count + '__ItemID" name="detail[' + count + '].ItemID" type="text" value="' + $("#abc").val() + '"></td>' +
                                                    '<td> <input class="form-control" readonly = "true" id="detail_' + count + '__MaterialName" name="detail[' + count + '].MaterialName" type="text" value="' + $("#abc option:selected").text().substring(0, $("#abc option:selected").text().indexOf('[')) + '"> </td>' +
                                                    '<td width="140px"><input class="form-control"  id="detail_' + count + '__Quatity" name="detail[' + count + '].Quatity" type="number" step = "0.00000000000001" min = "0" max = "1000000" value="1"></td>' +
                                                        '<td width="110px"><input class="form-control" readonly = "true" id="detail_' + count + '__Unit" name="detail[' + count + '].Unit" placeholder="đơn vị tính" type="text" value="' + $("#abc option:selected").text().substring($("#abc option:selected").text().indexOf('[')+1, $("#abc option:selected").text().indexOf(']')) + '"></td>' +
                                                        '<td width="130px"><select class="form-control" id="detail_' + count + '__Type" name="detail[' + count + '].Type"><option selected="selected" value="unit">Trên 1 SP</option> <option value="lot">Trên 1 Lô</option> </select></td>' +
                                                        '</tr>'
                                                    count = count + 1;
                                                    $(html).appendTo($("#gvCustomers"))
                                                }
                                            };

                                            $("#btnAddVT").click(addRowVT);

                                            $('.table tbody').on('click', '.xoadongR', function () {

                                                var sodong = $(this).attr("data-sodong") - 1;
                                                $('#detail_' + sodong + '__ItemID').attr("value", "");
                                                $(this).closest('tr').hide();
                                            });
                                        });
                                    </script>
                                    <script>
                                        $(document).ready(function () {
                                            $(window).keydown(function (event) {
                                                if (event.keyCode == 13) {
                                                    event.preventDefault();
                                                    return false;
                                                }
                                            });
                                        });
                                    </script>

                                </div>
                            </div>
                            <div class="card-footer">
                                    <button type="submit" class="btn btn-primary">Lưu thông tin</button>
                           </div>

                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
